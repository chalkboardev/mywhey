{% comment %}
  === FUNCTIONALITY ===

  Section notes:

  - Change title text
  - Carousel of products or limited to ‘X’ number
  - Scroll off screen on mobile
  - Tabs showing recently viewed collection input

  Section Author: Jeremy Lee
{% endcomment %}
<div class="tabbed_carousel_padding"></div>
{{ 'section-v2-recently-viewed.min.css' | asset_url | stylesheet_tag }}
{% assign tabs = section.blocks | where: 'type', 'tab' %}
{% assign tab_number = 1 %}

<div class="page-width" id="{{ section.id }}">
  {%- if tabs.size > 0 -%}
    {% for tab in tabs %}
      {% assign tab_number = forloop.index %}
      <input
        type="radio"
        name="tabs"
        id="tab{{ tab_number }}"
        {% if forloop.first %}
          checked
        {% endif %}
      >
      <label for="tab{{ tab_number }}">
        <h2 class="heading-lg">{{ tab.settings.tab_title }}</h2>
      </label>
    {% endfor %}
  {%- endif -%}

  {%- if section.settings.show_recently_viewed == true -%}
    {% assign tab_number = tab_number | plus: 1 %}
    <input
      type="radio"
      name="tabs"
      id="tab{{ tab_number }}"
      {% if tabs.size == 0 %}
        checked
      {% endif %}
    >
    <label for="tab{{ tab_number }}">
      <h2 class="heading-lg">{{ 'sections.recently_viewed.recently_viewed_title' | t }}</h2>
    </label>
  {%- endif -%}

  {% if section.settings.link != blank %}
    <a
      href="{{ section.settings.link }}"
      class="button-1 recently-viewed-button"
      aria-label="Link to {{ section.settings.link_text }}"
    >
      {{- section.settings.link_text -}}
    </a>
  {% endif %}

  <div class="custom-select">
    <select class="heading-md" value="">
      {%- if tabs.size > 0 -%}
        {% for tab in tabs %}
          {% assign tab_number = forloop.index %}
          <option value="content{{ tab_number }}" id="select-{{ tab.settings.tab_title | handleize }}">
            <h2 class="heading-md">{{ tab.settings.tab_title }}</h2>
          </option>
        {% endfor %}
      {% endif %}
      {% if section.settings.show_recently_viewed == true %}
        {% assign tab_number = tab_number | plus: 1 %}
        <option value="content{{ tab_number }}" id="select-recently-viewed">
          <h2 class="heading-md">{{ 'sections.recently_viewed.recently_viewed_title' | t }}</h2>
        </option>
      {% endif %}
    </select>
    <div class="select-chevron">
      {% render 'gb-icon', icon: 'chevron' %}
    </div>
  </div>

  {%- if tabs.size > 0 -%}
    {% comment %} {{ tabs.size }} {% endcomment %}
    {% for tab in tabs %}
      {% assign tab_number = forloop.index %}

      <div class="tab content{{ tab_number }}">
          {% if section.settings.collection_slider_navigation == true %}
            <!-- If we need navigation buttons -->
            <div class="tabbed-{{ section.index }} swiper-button-prev"></div>
          {% endif %}
          <!-- If we need navigation buttons -->
          {% if section.settings.collection_slider_navigation == true %}
            <div class="tabbed-{{ section.index }} swiper-button-next"></div>
          {% endif %}

        <div class="swiper best-sellers-swiper-{{ section.index }}">
          <div class="swiper-wrapper">
            {%- for product in tab.settings.collection.products -%}
              <div class="swiper-slide">
                {% render 'gb-product-card', product: product, swiper: true %}
              </div>
            {%- endfor -%}
          </div>
           <!-- If we need pagination -->
          {% if section.settings.collection_slider_pagination == true %}
            <div class="collection-swiper-pagination swiper-pagination"></div>
          {% endif %}
        </div>
      </div>
    {%- endfor -%}
  {%- endif -%}

  {% if section.settings.show_recently_viewed == true %}
    {% assign tab_number = tab_number | plus: 1 %}
    <div class="tab content{{ tab_number }}">
      
        {% if section.settings.collection_slider_navigation == true %}
        <!-- If we need navigation buttons -->
          <div class="tabbed-{{ section.index }} swiper-button-prev"></div>
        {% endif %}
        <!-- If we need navigation buttons -->
        {% if section.settings.collection_slider_navigation == true %}
          <div class="tabbed-{{ section.index }} swiper-button-next"></div>
        {% endif %}

      <div class="swiper recently-swiper-{{ section.index }}">
        <div class="swiper-wrapper recently-viewed-slider"></div>
        <!-- If we need pagination -->
        {% if section.settings.collection_slider_pagination_recent == true %}
          <div class="pager-{{ section.index }} collection-swiper-pagination swiper-pagination"></div>
        {% endif %}
      </div>
    </div>
  {%- endif -%}
</div>

<script>
  let select = document.querySelector('.tabbed-collection-carousel select');
  let options = document.querySelectorAll('.tabbed-collection-carousel select option');

  if (select) {
    select.addEventListener('change', (e) => {
      let contents = document.querySelectorAll('.tabbed-collection-carousel .tab');
      contents.forEach((content) => {
        content.style.display = 'none';
      });
      document.querySelector('.tabbed-collection-carousel .' + e.target.value).style.display = 'block';
    });
  }
  
</script>

<script>
  var my_swiper = new window.swiper(".best-sellers-swiper-{{ section.index }}", {
      spaceBetween: 20,
      slidesPerView: 1,
      initialSlide: 1,
      lazy: {
          enabled: true,
          checkInView: true,
          centeredSlides: true,
          loadOnTransitionStart: true,
          loadPrevNext: true,
          loadPrevNextAmount: 1
      },
      loop: {{ section.settings.collection_slider_loop }},
      {% if section.settings.collection_slider_pagination %}
          // If we need pagination
          pagination: {
              el: '.collection-swiper-pagination.swiper-pagination',
              clickable: true,
              dynamicBullets: true,
          },
      {% endif %}

      {% if section.settings.collection_slider_navigation == true %}
          // Navigation arrows
          navigation: {
              nextEl: '.tabbed-{{ section.index }}.swiper-button-next',
              prevEl: '.tabbed-{{ section.index }}.swiper-button-prev',
          },
      {% endif %}

      {% if section.settings.collection_slider_scrollbar == true %}
          // And if we need scrollbar
          scrollbar: {
              el: '.collection-swiper-scrollbar.swiper-scrollbar',
          },
      {% endif %}
      breakpoints: {
          0: {
            slidesPerView: 1.3
          },
          360: {
            slidesPerView: 1.3
          },
          425: {
            slidesPerView: 2.3
          },
          768: {
              slidesPerView: {{ section.settings.slidesSmall }}
          },
          992: {
              slidesPerView: {{ section.settings.slidesMid }}
          },
          1200: {
              slidesPerView: {{ section.settings.slidesLarge }}
          }
      },
  });

  var my_swiper_recent = new window.swiper(".recently-swiper-{{ section.index }}", {
      spaceBetween: 20,
      slidesPerView: 1,
      initialSlide: 1,
      lazy: {
          enabled: true,
          checkInView: true,
          centeredSlides: true,
          loadOnTransitionStart: true,
          loadPrevNext: true,
          loadPrevNextAmount: 1
      },
      loop: true,
      {% if section.settings.collection_slider_pagination_recent %}
          // If we need pagination
          pagination: {
              el: '.pager-{{ section.index }}.collection-swiper-pagination.swiper-pagination',
              clickable: true,
              dynamicBullets: true,
          },
      {% endif %}

      {% if section.settings.collection_slider_navigation == true %}
          // Navigation arrows
          navigation: {
              nextEl: '.tabbed-{{ section.index }}.swiper-button-next',
              prevEl: '.tabbed-{{ section.index }}.swiper-button-prev',
          },
      {% endif %}

      {% if section.settings.collection_slider_scrollbar == true %}
          // And if we need scrollbar
          scrollbar: {
              el: '.collection-swiper-scrollbar.swiper-scrollbar',
          },
      {% endif %}
      breakpoints: {
          0: {
            slidesPerView: 1.3
          },
          360: {
            slidesPerView: 1.3
          },
          425: {
            slidesPerView: 2.3
          },
          768: {
              slidesPerView: {{ section.settings.slidesSmall }}
          },
          992: {
              slidesPerView: {{ section.settings.slidesMid }}
          },
          1200: {
              slidesPerView: {{ section.settings.slidesLarge }}
          }
      },
  });
</script>

<script src="{{ 'recently-viewed.min.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "Tabbed collection slider",
  "tag": "section",
  "class": "recently-viewed tabbed-collection-carousel vertical-margin",
  "settings": [
    {
      "type": "text",
      "id": "link_text",
      "label": "Link text",
      "default": "View all products"
    },
    {
      "type": "url",
      "id": "link",
      "label": "Link",
      "info": "Button link"
    },
    {
      "type": "checkbox",
      "id": "show_recently_viewed",
      "label": "Show recently viewed",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "collection_slider_pagination",
      "label": "Slider Pagination",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "collection_slider_pagination_recent",
      "label": "Recent Slider Pagination",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "collection_slider_navigation",
      "label": "USP Slider Navigation",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "collection_slider_scrollbar",
      "label": "USP Slider Scrollbar"
    },
    {
      "type": "checkbox",
      "id": "collection_slider_loop",
      "label": "USP Slider Loop",
      "default": false
    },
    {
        "type": "select",
        "id": "slidesLarge",
        "label": "Slides per view at largest breakpoint",
        "options": [
          {
            "value": "5",
            "label": "5"
          },
          {
            "value": "4",
            "label": "4"
          },
          {
            "value": "3",
            "label": "3"
          }
        ],
        "default": "4"
      },
      {
          "type": "select",
          "id": "slidesMid",
          "label": "Slides per view at middle breakpoint",
          "options": [
            {
              "value": "5",
              "label": "5"
            },
            {
              "value": "4",
              "label": "4"
            },
            {
              "value": "3",
              "label": "3"
            }
          ],
          "default": "4"
        },
        {
            "type": "select",
            "id": "slidesSmall",
            "label": "Slides per view at smallest breakpoint",
            "options": [
              {
                "value": "5",
                "label": "5"
              },
              {
                "value": "4",
                "label": "4"
              },
              {
                "value": "3",
                "label": "3"
              }
            ],
            "default": "4"
        }
  ],
  "blocks": [
    {
      "type": "tab",
      "name": "Tab",
      "limit": 4,
      "settings": [
        {
          "type": "text",
          "id": "tab_title",
          "label": "Tab title"
        },
        {
          "type": "collection",
          "id": "collection",
          "label": "Collection"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Tabbed collection slider"
    }
  ]
}
{% endschema %}
